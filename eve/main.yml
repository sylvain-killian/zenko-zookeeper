version: "0.2"

branches:
  default:
    stage: "pre-merge"

stages:
  pre-merge:
    worker: &pod
      type: kube_pod
      path: eve/workers/zenko.yaml
      images:
        aggressor: eve/workers/aggressor
    steps:
    - TriggerStages:
        name: trigger all the tests
        stage_names:
        - cluster_1_9_6

  cluster_1_9_6:
    worker:
      <<: *pod
      service:
        requests:
          version: "1.9.6"
        namespaces:
        - "testNamespace"    # <<< the default namespace for that stage
    steps:
    - Git: &git_pull
        name: git pull
        repourl: "%(prop:git_reference)s"
        mode: full
        method: clobber
        retryFetch: true
        haltOnFailure: true
    - ShellCommand:
        name: install helm (tiller into kubernetes)
        command: >-
          helm init
          --tiller-namespace %(prop:testNamespace)s
          --service-account default
          --override spec.template.spec.containers[0].resources.limits.cpu=0.5
          --override spec.template.spec.containers[0].resources.limits.memory=1G
          --override spec.template.spec.containers[0].resources.requests.cpu=0.1
          --override spec.template.spec.containers[0].resources.requests.memory=100M
          --wait
    - ShellCommand:
        name: list files
        command: ls
    - ShellCommand:
        name: can access the default namespace (first in list)
        command: >-
          helm install --tiller-namespace %(prop:testNamespace)s --wait
          --namespace  %(prop:testNamespace)s
          --name zenko-zookeeper-test charts/zenko-zookeeper
